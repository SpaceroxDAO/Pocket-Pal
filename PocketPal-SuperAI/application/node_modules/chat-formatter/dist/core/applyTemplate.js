"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const templates_1 = require("../templates");
const nunjucksEnvironment_1 = require("../utils/nunjucksEnvironment");
const applyTemplate = (conversation, options = {}) => {
    const { templateKey = 'default', customTemplate, addGenerationPrompt = false, isBeginningOfSequence, isEndOfSequence } = options;
    const nunjucksEnv = (0, nunjucksEnvironment_1.setupNunjucksEnvironment)();
    // If both templateKey and customTemplate are provided, customTemplate takes precedence.
    const template = customTemplate ?? templates_1.templates[templateKey];
    const templateString = template.chatTemplate;
    const renderTemplate = (chat) => {
        let result = nunjucksEnv.renderString(templateString, {
            messages: chat,
            add_generation_prompt: addGenerationPrompt,
            bos_token: template.bosToken,
            eos_token: template.eosToken
        });
        const shouldAddBosToken = isBeginningOfSequence !== undefined
            ? isBeginningOfSequence
            : template.addBosToken;
        const shouldAddEosToken = isEndOfSequence !== undefined ? isEndOfSequence : template.addEosToken;
        if (shouldAddBosToken && template.bosToken) {
            if (!result.startsWith(template.bosToken)) {
                result = template.bosToken + result;
            }
        }
        if (shouldAddEosToken && template.eosToken) {
            if (!result.endsWith(template.eosToken)) {
                result += template.eosToken;
            }
        }
        return result;
    };
    if (Array.isArray(conversation[0])) {
        return conversation.map(renderTemplate);
    }
    else {
        return renderTemplate(conversation);
    }
};
exports.default = applyTemplate;
